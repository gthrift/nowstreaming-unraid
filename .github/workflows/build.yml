name: Build Plugin Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2026.01.15)'
        required: true
      release_notes:
        description: 'Release notes (use \n for new lines)'
        required: false
        default: '- Rebrand to What''s Streaming?'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Using version: ${VERSION}"
      
      - name: Build txz package
        id: build
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PLUGIN_NAME="whatsstreaming"
          
          echo "Building ${PLUGIN_NAME} version ${VERSION}..."
          
          # Create archive directory
          mkdir -p archive
          
          # Create temporary directory structure
          TEMP_DIR=$(mktemp -d)
          PLUGIN_DIR="${TEMP_DIR}/usr/local/emhttp/plugins/${PLUGIN_NAME}"
          mkdir -p "${PLUGIN_DIR}"
          
          echo "Created temp directory: ${TEMP_DIR}"
          echo "Plugin directory: ${PLUGIN_DIR}"
          
          # Copy source files with error checking
          echo "Copying .page files..."
          if ls src/*.page 1> /dev/null 2>&1; then
            cp src/*.page "${PLUGIN_DIR}/"
            echo "  Copied .page files"
          else
            echo "  WARNING: No .page files found in src/"
          fi
          
          echo "Copying .php files..."
          if ls src/*.php 1> /dev/null 2>&1; then
            cp src/*.php "${PLUGIN_DIR}/"
            echo "  Copied .php files"
          else
            echo "  WARNING: No .php files found in src/"
          fi
          
          echo "Copying .png files..."
          if ls metadata/*.png 1> /dev/null 2>&1; then
            cp metadata/*.png "${PLUGIN_DIR}/"
            echo "  Copied .png files"
          else
            echo "  WARNING: No .png files found in metadata/"
          fi
          
          # Show what we're packaging
          echo ""
          echo "=== Files to be packaged ==="
          find "${TEMP_DIR}" -type f
          
          # Check if we have any files to package
          FILE_COUNT=$(find "${PLUGIN_DIR}" -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ERROR: No files to package!"
            exit 1
          fi
          
          # Create txz archive
          ARCHIVE_NAME="${PLUGIN_NAME}-${VERSION}.txz"
          echo ""
          echo "Creating archive: ${ARCHIVE_NAME}"
          
          cd "${TEMP_DIR}"
          tar -cJf "${GITHUB_WORKSPACE}/archive/${ARCHIVE_NAME}" .
          cd "${GITHUB_WORKSPACE}"
          
          # Verify archive was created
          if [ ! -f "archive/${ARCHIVE_NAME}" ]; then
            echo "ERROR: Failed to create archive!"
            exit 1
          fi
          
          echo "Archive created successfully: $(ls -lh archive/${ARCHIVE_NAME})"
          
          # Generate MD5
          MD5_HASH=$(md5sum "archive/${ARCHIVE_NAME}" | awk '{print $1}')
          echo "${MD5_HASH}" > "archive/${PLUGIN_NAME}-${VERSION}.md5"
          
          # Output for next steps
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
          echo "MD5_HASH=${MD5_HASH}" >> $GITHUB_ENV
          
          echo ""
          echo "=========================================="
          echo "Build complete!"
          echo "Archive: archive/${ARCHIVE_NAME}"
          echo "MD5: ${MD5_HASH}"
          echo "=========================================="
          
          # Clean up
          rm -rf "${TEMP_DIR}"
      
      - name: Update plg file with new version, MD5, and release notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          PLUGIN_FILE="whatsstreaming.plg"
          
          echo "Updating ${PLUGIN_FILE}..."
          echo "  Version: ${VERSION}"
          echo "  MD5: ${MD5_HASH}"
          
          # Update version in plg file
          sed -i 's/<!ENTITY version[[:space:]]*"[^"]*"/<!ENTITY version   "'"${VERSION}"'"/' "${PLUGIN_FILE}"
          
          # Update MD5 in plg file
          sed -i 's/<!ENTITY md5[[:space:]]*"[^"]*"/<!ENTITY md5       "'"${MD5_HASH}"'"/' "${PLUGIN_FILE}"
          
          # Add release notes if provided (for manual triggers only)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${RELEASE_NOTES}" ]; then
            echo "  Adding release notes..."
            
            # Convert \n to actual newlines
            FORMATTED_NOTES=$(echo "${RELEASE_NOTES}" | sed 's/\\n/\n/g')
            
            # Create the new changelog entry
            NEW_ENTRY="###${VERSION}\n${FORMATTED_NOTES}\n\n"
            
            # Insert after <CHANGES> tag
            sed -i "s|<CHANGES>|<CHANGES>\n${NEW_ENTRY}|" "${PLUGIN_FILE}"
            
            echo "  Release notes added"
          fi
          
          echo ""
          echo "Updated plg file:"
          grep -A 5 "<CHANGES>" "${PLUGIN_FILE}" | head -10
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add archive/ whatsstreaming.plg
          
          # Commit (don't fail if no changes)
          git diff --staged --quiet && echo "No changes to commit" || git commit -m "Build version ${{ steps.version.outputs.VERSION }}"
          
          # Push changes
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            archive/${{ env.ARCHIVE_NAME }}
            archive/whatsstreaming-${{ steps.version.outputs.VERSION }}.md5
          body: |
            ## What's Streaming? v${{ steps.version.outputs.VERSION }}
            
            **MD5:** `${{ env.MD5_HASH }}`
            
            ### Installation
            ```
            [https://raw.githubusercontent.com/gthrift/whatsstreaming-unraid/main/whatsstreaming.plg](https://raw.githubusercontent.com/gthrift/whatsstreaming-unraid/main/whatsstreaming.plg)
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
