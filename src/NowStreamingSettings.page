Menu="Utilities"
Type="xmenu"
Title="Now Streaming Settings"
Tag="film"
Icon="film"
Markdown="false"
---
<?php
    $plugin = "nowstreaming";
    $translations = file_exists("$docroot/webGui/include/Translations.php");
?>
<?if (!$translations):?>
    <div style="padding: 20px;">Please update Unraid to use this plugin.</div>
<?else:?>
---
<style>
    /* Section styling - uses transparent overlays to work with any theme */
    .as-section { 
        margin-bottom: 30px;
        padding: 20px; 
        background: rgba(128,128,128,0.1); 
        border-radius: 8px; 
    }
    .as-section h3 { 
        margin-top: 0;
        border-bottom: 1px solid rgba(128,128,128,0.2); 
        padding-bottom: 10px; 
    }
    
    /* Server list */
    .as-server-list { margin: 15px 0; }
    .as-server-item { 
        display: flex; 
        align-items: center;
        padding: 10px 15px; 
        margin: 5px 0; 
        background: rgba(128,128,128,0.1); 
        border-radius: 5px; 
        gap: 15px;
    }
    .as-server-item .server-type { 
        font-weight: bold; 
        width: 80px;
        text-transform: capitalize;
    }
    .as-server-item .server-name { flex: 1; }
    .as-server-item .server-host { opacity: 0.7; flex: 1; }
    .as-server-item .server-actions { display: flex; gap: 10px; }
    
    /* Buttons */
    .as-btn { 
        padding: 8px 16px;
        cursor: pointer; 
        border-radius: 4px;
        border: 1px solid;
        font-weight: normal;
    }
    .as-btn-primary { 
        background: #ff9800;
        color: #000; 
        border-color: #ff9800;
    }
    .as-btn-primary:hover { background: #ffaa2e; }
    .as-btn-danger { 
        background: #c53a3a; 
        color: #fff; 
        border-color: #c53a3a;
    }
    .as-btn-danger:hover { background: #d54a4a; }
    .as-btn-secondary { 
        background: rgba(128,128,128,0.3); 
        color: inherit; 
        border-color: rgba(128,128,128,0.5);
    }
    .as-btn-secondary:hover { background: rgba(128,128,128,0.4); }
    
    /* Modal Overlay */
    .as-modal { 
        display: none;
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.7); 
        z-index: 1000;
    }
    
    /* Modal Content */
    .as-modal-content { 
        position: absolute;
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        background: inherit;
        background-color: var(--background-color, #1c1b1b);
        padding: 25px; 
        border-radius: 10px; 
        min-width: 450px;
        max-width: 90%;
        border: 1px solid rgba(128,128,128,0.3);
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        color: inherit;
    }
    .as-modal-content h3 { 
        margin-top: 0; 
        color: #ff9800;
        border-bottom: 1px solid rgba(128,128,128,0.3);
        padding-bottom: 15px;
        margin-bottom: 20px;
    }
    
    /* Form Rows */
    .as-form-row { margin: 18px 0; }
    .as-form-row > label { 
        display: block; 
        margin-bottom: 8px;
        font-weight: bold; 
        font-size: 14px;
    }
    
    .as-modal-content input[type="text"],
    .as-modal-content input[type="number"],
    .as-modal-content input[type="password"],
    .as-modal-content select {
        width: 100%;
        padding: 8px 10px; 
        box-sizing: border-box;
        font-size: 14px;
    }
    
    .as-modal-content input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
    }
    
    .as-form-row .hint { 
        font-size: 12px;
        opacity: 0.6;
        margin-top: 6px;
        line-height: 1.4;
    }
    
    .type-plex { color: #e5a00d; }
    .type-emby { color: #52b54b; }
    .type-jellyfin { color: #00a4dc; }
    
    .as-test-result { 
        margin-top: 15px;
        padding: 12px 15px; 
        border-radius: 4px; 
        display: none;
        font-size: 14px;
    }
    .as-test-success { 
        background: rgba(82, 181, 75, 0.2);
        color: #5cb85c;
        border: 1px solid rgba(82, 181, 75, 0.4);
    }
    .as-test-error { 
        background: rgba(217, 83, 79, 0.2);
        color: #d9534f;
        border: 1px solid rgba(217, 83, 79, 0.4);
    }
    
    .as-modal-buttons {
        display: flex;
        gap: 10px; 
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid rgba(128,128,128,0.3);
    }
    
    .as-modal-buttons .as-btn {
        padding: 10px 20px;
        font-size: 14px;
    }
    
    .as-checkbox-row {
        display: flex;
        align-items: center;
        margin: 20px 0;
    }
    .as-checkbox-row label {
        display: flex;
        align-items: center;
        margin-bottom: 0;
        cursor: pointer;
        font-weight: normal;
    }
</style>

<?php
// Load Config
$cfg_file = "/boot/config/plugins/nowstreaming/nowstreaming.cfg";
$servers_file = "/boot/config/plugins/nowstreaming/servers.json";
$cfg = file_exists($cfg_file) ? parse_ini_file($cfg_file) : [];

// Set Defaults
$cfg['DISPLAY_WIDGET'] = $cfg['DISPLAY_WIDGET'] ?? "1";
$cfg['POLL_INTERVAL'] = $cfg['POLL_INTERVAL'] ?? "5";
$cfg['WIDGET_ICON'] = $cfg['WIDGET_ICON'] ?? "streams";
$cfg['WIDGET_TITLE'] = $cfg['WIDGET_TITLE'] ?? "Now Streaming";

// Load servers
$servers = file_exists($servers_file) ? json_decode(file_get_contents($servers_file), true) : [];
if (!is_array($servers)) $servers = [];

// Toggle Widget
$pluginPath = '/usr/local/emhttp/plugins/nowstreaming/';
if ($cfg['DISPLAY_WIDGET'] === '0' && file_exists($pluginPath . 'NowStreaming.page')) {
    rename($pluginPath . 'NowStreaming.page', $pluginPath . 'NowStreaming.page.off');
} else if ($cfg['DISPLAY_WIDGET'] === '1' && file_exists($pluginPath . 'NowStreaming.page.off')) {
    rename($pluginPath . 'NowStreaming.page.off', $pluginPath . 'NowStreaming.page');
}
?>

<div class="as-section">
    <h3><i class="fa fa-cog"></i> _(General Settings)_</h3>
    <form name="nowstreaming_settings" id="nowstreaming_settings" method="POST" action="/update.php" target="progressFrame">
        <input type="hidden" name="#file" value="nowstreaming/nowstreaming.cfg" />
        
        <div class="as-form-row">
            <label>_(Widget Title)_:</label>
            <select name="WIDGET_TITLE" style="width: 200px;">
                <option value="Now Streaming" <?php echo($cfg['WIDGET_TITLE'] === "Now Streaming" ? "selected" : ""); ?>>Now Streaming</option>
                <option value="Active Streams" <?php echo($cfg['WIDGET_TITLE'] === "Active Streams" ? "selected" : ""); ?>>Active Streams</option>
                <option value="Video Streams" <?php echo($cfg['WIDGET_TITLE'] === "Video Streams" ? "selected" : ""); ?>>Video Streams</option>
                <option value="Plex Streams" <?php echo($cfg['WIDGET_TITLE'] === "Plex Streams" ? "selected" : ""); ?>>Plex Streams</option>
                <option value="Emby Streams" <?php echo($cfg['WIDGET_TITLE'] === "Emby Streams" ? "selected" : ""); ?>>Emby Streams</option>
                <option value="Jellyfin Streams" <?php echo($cfg['WIDGET_TITLE'] === "Jellyfin Streams" ? "selected" : ""); ?>>Jellyfin Streams</option>
            </select>
        </div>
        
        <div class="as-form-row">
            <label>_(Widget Icon)_:</label>
            <select name="WIDGET_ICON" style="width: 200px;">
                <option value="streams" <?php echo($cfg['WIDGET_ICON'] === "streams" ? "selected" : ""); ?>>Generic (Film)</option>
                <option value="plex" <?php echo($cfg['WIDGET_ICON'] === "plex" ? "selected" : ""); ?>>Plex</option>
                <option value="emby" <?php echo($cfg['WIDGET_ICON'] === "emby" ? "selected" : ""); ?>>Emby</option>
                <option value="jellyfin" <?php echo($cfg['WIDGET_ICON'] === "jellyfin" ? "selected" : ""); ?>>Jellyfin</option>
            </select>
        </div>
        
        <div class="as-form-row">
            <label>_(Refresh Interval)_:</label>
            <input type="number" name="POLL_INTERVAL" value="<?php echo($cfg['POLL_INTERVAL']); ?>" min="1" max="60" style="width: 80px;"> _(seconds)_
        </div>
        
        <div class="as-form-row">
            <label>_(Display Dashboard Widget)_:</label>
            <input type="radio" name="DISPLAY_WIDGET" value="1" <?php echo($cfg['DISPLAY_WIDGET'] === "1" ? "checked" : ""); ?>/> _(On)_
            <input type="radio" name="DISPLAY_WIDGET" value="0" <?php echo($cfg['DISPLAY_WIDGET'] === "0" ? "checked" : ""); ?>/> _(Off)_
        </div>
        
        <input type="submit" value="_(Save Settings)_" class="as-btn as-btn-primary">
    </form>
</div>

<div class="as-section">
    <h3><i class="fa fa-server"></i> _(Media Servers)_</h3>
    <p>_(Configure your Plex, Emby, and Jellyfin servers below.)_</p>
    
    <div class="as-server-list" id="serverList">
        <?php if (empty($servers)): ?>
            <div class="as-server-item" style="justify-content: center; opacity: 0.7;">
                <i class="fa fa-info-circle"></i> _(No servers configured. Add one below.)_
            </div>
        <?php else: ?>
            <?php foreach ($servers as $index => $server): ?>
                <div class="as-server-item" data-index="<?php echo $index; ?>">
                    <span class="server-type type-<?php echo htmlspecialchars($server['type']); ?>">
                        <i class="fa fa-<?php echo $server['type'] === 'plex' ? 'play-circle' : ($server['type'] === 'emby' ? 'film' : 'film'); ?>"></i>
                        <?php echo htmlspecialchars($server['type']); ?>
                    </span>
                    <span class="server-name"><?php echo htmlspecialchars($server['name']); ?></span>
                    <span class="server-host"><?php echo htmlspecialchars($server['host']); ?>:<?php echo htmlspecialchars($server['port']); ?></span>
                    <span class="server-actions">
                        <button type="button" class="as-btn as-btn-secondary" onclick="editServer(<?php echo $index; ?>)"><i class="fa fa-pencil"></i></button>
                        <button type="button" class="as-btn as-btn-danger" onclick="deleteServer(<?php echo $index; ?>)"><i class="fa fa-trash"></i></button>
                    </span>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
    
    <button type="button" class="as-btn as-btn-primary" onclick="openAddModal()">
        <i class="fa fa-plus"></i> _(Add Server)_
    </button>
</div>

<div class="as-modal" id="serverModal">
    <div class="as-modal-content">
        <h3 id="modalTitle"><i class="fa fa-server"></i> _(Add Server)_</h3>
        <form id="serverForm">
            <input type="hidden" id="editIndex" value="-1">
            
            <div class="as-form-row">
                <label for="serverType">_(Server Type)_:</label>
                <select id="serverType" onchange="updateFormFields()">
                    <option value="plex">Plex</option>
                    <option value="emby">Emby</option>
                    <option value="jellyfin">Jellyfin</option>
                </select>
            </div>
            
            <div class="as-form-row">
                <label for="serverName">_(Display Name)_:</label>
                <input type="text" id="serverName" placeholder="My Plex Server" required>
                <div class="hint">_(A friendly name to identify this server)_</div>
            </div>
            
            <div class="as-form-row">
                <label for="serverHost">_(Host IP/Hostname)_:</label>
                <input type="text" id="serverHost" placeholder="192.168.1.50" required>
            </div>
            
            <div class="as-form-row">
                <label for="serverPort">_(Port)_:</label>
                <input type="number" id="serverPort" placeholder="32400">
                <div class="hint" id="portHint">_(Default: 32400 for Plex)_</div>
            </div>
            
            <div class="as-form-row">
                <label for="serverToken" id="tokenLabel">_(Plex Token)_:</label>
                <input type="password" id="serverToken" placeholder="Enter your token/API key" required>
                <div class="hint" id="tokenHint">_(Find your X-Plex-Token in browser dev tools or Plex settings)_</div>
            </div>
            
            <div class="as-checkbox-row">
                <label>
                    <input type="checkbox" id="serverSSL"> _(Use HTTPS/SSL)_
                </label>
            </div>
            
            <div class="as-test-result" id="testResult"></div>
            
            <div class="as-modal-buttons">
                <button type="button" class="as-btn as-btn-secondary" onclick="testConnection()">
                    <i class="fa fa-plug"></i> _(Test Connection)_
                </button>
                <button type="submit" class="as-btn as-btn-primary">
                    <i class="fa fa-save"></i> _(Save Server)_
                </button>
                <button type="button" class="as-btn as-btn-secondary" onclick="closeModal()">
                    _(Cancel)_
                </button>
            </div>
        </form>
    </div>
</div>

<script>
var servers = <?php echo json_encode($servers); ?>;

$(function() {
    var bgColor = getComputedStyle(document.body).backgroundColor;
    if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)') {
        $('.as-modal-content').css('background-color', bgColor);
    }
});

function updateFormFields() {
    var type = $('#serverType').val();
    var ports = { plex: 32400, emby: 8096, jellyfin: 8096 };
    var hints = { 
        plex: '_(Default: 32400 for Plex)_', 
        emby: '_(Default: 8096 for Emby, 8920 for HTTPS)_', 
        jellyfin: '_(Default: 8096 for Jellyfin, 8920 for HTTPS)_' 
    };
    var tokenHints = {
        plex: '_(Find your X-Plex-Token in browser dev tools or Plex settings)_',
        emby: '_(Generate in Emby Dashboard > Advanced > API Keys)_',
        jellyfin: '_(Generate in Jellyfin Dashboard > Advanced > API Keys)_'
    };
    $('#serverPort').attr('placeholder', ports[type]);
    $('#portHint').text(hints[type]);
    $('#tokenHint').text(tokenHints[type]);
    $('#tokenLabel').text(type === 'plex' ? '_(Plex Token)_:' : '_(API Key)_:');
}

function openAddModal() {
    $('#editIndex').val(-1);
    $('#modalTitle').html('<i class="fa fa-server"></i> _(Add Server)_');
    $('#serverForm')[0].reset();
    $('#serverType').val('plex');
    updateFormFields();
    $('#testResult').hide();
    $('#serverModal').fadeIn(200);
}

function editServer(index) {
    var server = servers[index];
    $('#editIndex').val(index);
    $('#modalTitle').html('<i class="fa fa-server"></i> _(Edit Server)_');
    $('#serverType').val(server.type);
    $('#serverName').val(server.name);
    $('#serverHost').val(server.host);
    $('#serverPort').val(server.port);
    $('#serverToken').val(server.token);
    $('#serverSSL').prop('checked', server.ssl === true || server.ssl === '1');
    updateFormFields();
    $('#testResult').hide();
    $('#serverModal').fadeIn(200);
}

function closeModal() {
    $('#serverModal').fadeOut(200);
}

function deleteServer(index) {
    if (confirm('_(Are you sure you want to delete this server?)_')) {
        $.post('/plugins/nowstreaming/nowstreaming_servers.php', {
            action: 'delete',
            index: index
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('_(Error deleting server)_: ' + response.error);
            }
        }, 'json');
    }
}

function testConnection() {
    var data = {
        action: 'test',
        type: $('#serverType').val(),
        host: $('#serverHost').val(),
        port: $('#serverPort').val() || getDefaultPort($('#serverType').val()),
        token: $('#serverToken').val(),
        ssl: $('#serverSSL').is(':checked') ? '1' : '0'
    };
    
    $('#testResult').removeClass('as-test-success as-test-error').html('<i class="fa fa-spinner fa-spin"></i> _(Testing...)_').show();
    $.post('/plugins/nowstreaming/nowstreaming_servers.php', data, function(response) {
        if (response.success) {
            $('#testResult').removeClass('as-test-error').addClass('as-test-success')
                .html('<i class="fa fa-check"></i> _(Connection successful!)_ ' + (response.message || ''));
        } else {
            $('#testResult').removeClass('as-test-success').addClass('as-test-error')
                .html('<i class="fa fa-times"></i> _(Connection failed)_: ' + response.error);
        }
    }, 'json').fail(function() {
        $('#testResult').removeClass('as-test-success').addClass('as-test-error')
            .html('<i class="fa fa-times"></i> _(Request failed)_');
    });
}

function getDefaultPort(type) {
    return type === 'plex' ? 32400 : 8096;
}

$('#serverForm').on('submit', function(e) {
    e.preventDefault();
    
    var data = {
        action: $('#editIndex').val() === '-1' ? 'add' : 'edit',
        index: $('#editIndex').val(),
        type: $('#serverType').val(),
        name: $('#serverName').val(),
        host: $('#serverHost').val(),
        port: $('#serverPort').val() || getDefaultPort($('#serverType').val()),
        token: $('#serverToken').val(),
        ssl: $('#serverSSL').is(':checked') ? '1' : '0'
    };
    
    $.post('/plugins/nowstreaming/nowstreaming_servers.php', data, function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('_(Error saving server)_: ' + response.error);
        }
    }, 'json');
});

$('#serverModal').on('click', function(e) {
    if (e.target === this) closeModal();
});
</script>

<?endif;?>
