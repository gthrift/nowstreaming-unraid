Menu="ActiveStreams"
Title="Active Streams Settings"
Tag="film"
---
<?php
    $plugin = "activestreams";
    $translations = file_exists("$docroot/webGui/include/Translations.php");
?>
<?if (!$translations):?>
    <div style="padding: 20px;">Please update Unraid to use this plugin.</div>
<?else:?>
---
<style>
    .as-section { margin-bottom: 30px; padding: 20px; background: rgba(0,0,0,0.1); border-radius: 8px; }
    .as-section h3 { margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .as-server-list { margin: 15px 0; }
    .as-server-item { 
        display: flex; 
        align-items: center; 
        padding: 10px 15px; 
        margin: 5px 0; 
        background: rgba(0,0,0,0.2); 
        border-radius: 5px; 
        gap: 15px;
    }
    .as-server-item .server-type { 
        font-weight: bold; 
        width: 80px; 
        text-transform: capitalize;
    }
    .as-server-item .server-name { flex: 1; }
    .as-server-item .server-host { color: #888; flex: 1; }
    .as-server-item .server-actions { display: flex; gap: 10px; }
    .as-server-item .server-actions button { padding: 5px 12px; cursor: pointer; }
    .as-btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; }
    .as-btn-primary { background: #ff9800; color: #000; }
    .as-btn-danger { background: #d44; color: #fff; }
    .as-btn-secondary { background: #555; color: #fff; }
    .as-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
    .as-modal-content { 
        position: absolute; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        background: #1c1c1c; 
        padding: 25px; 
        border-radius: 10px; 
        min-width: 400px;
        max-width: 90%;
    }
    .as-modal-content h3 { margin-top: 0; }
    .as-form-row { margin: 15px 0; }
    .as-form-row label { display: block; margin-bottom: 5px; font-weight: bold; }
    .as-form-row input, .as-form-row select { width: 100%; padding: 8px; box-sizing: border-box; }
    .as-form-row .hint { font-size: 12px; color: #888; margin-top: 5px; }
    .type-plex { color: #e5a00d; }
    .type-emby { color: #52b54b; }
    .type-jellyfin { color: #00a4dc; }
    .as-test-result { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
    .as-test-success { background: rgba(82, 181, 75, 0.2); color: #52b54b; }
    .as-test-error { background: rgba(221, 68, 68, 0.2); color: #d44; }
</style>

<?php
// Load Config
$cfg_file = "/boot/config/plugins/activestreams/activestreams.cfg";
$servers_file = "/boot/config/plugins/activestreams/servers.json";
$cfg = file_exists($cfg_file) ? parse_ini_file($cfg_file) : [];

// Set Defaults
$cfg['DISPLAY_WIDGET'] = $cfg['DISPLAY_WIDGET'] ?? "1";
$cfg['POLL_INTERVAL'] = $cfg['POLL_INTERVAL'] ?? "5";
$cfg['WIDGET_ICON'] = $cfg['WIDGET_ICON'] ?? "streams";
$cfg['WIDGET_TITLE'] = $cfg['WIDGET_TITLE'] ?? "Active Streams";

// Load servers
$servers = file_exists($servers_file) ? json_decode(file_get_contents($servers_file), true) : [];
if (!is_array($servers)) $servers = [];

// Toggle Widget
$pluginPath = '/usr/local/emhttp/plugins/activestreams/';
if ($cfg['DISPLAY_WIDGET'] === '0' && file_exists($pluginPath . 'ActiveStreams.page')) {
    rename($pluginPath . 'ActiveStreams.page', $pluginPath . 'ActiveStreams.page.off');
} else if ($cfg['DISPLAY_WIDGET'] === '1' && file_exists($pluginPath . 'ActiveStreams.page.off')) {
    rename($pluginPath . 'ActiveStreams.page.off', $pluginPath . 'ActiveStreams.page');
}
?>

<!-- General Settings Section -->
<div class="as-section">
    <h3><i class="fa fa-cog"></i> _(General Settings)_</h3>
    <form name="activestreams_settings" id="activestreams_settings" method="POST" action="/update.php" target="progressFrame">
        <input type="hidden" name="#file" value="activestreams/activestreams.cfg" />
        
        <div class="as-form-row">
            <label>_(Widget Title)_:</label>
            <select name="WIDGET_TITLE" style="width: 200px;">
                <option value="Active Streams" <?php echo($cfg['WIDGET_TITLE'] === "Active Streams" ? "selected" : ""); ?>>Active Streams</option>
                <option value="Video Streams" <?php echo($cfg['WIDGET_TITLE'] === "Video Streams" ? "selected" : ""); ?>>Video Streams</option>
                <option value="Plex Streams" <?php echo($cfg['WIDGET_TITLE'] === "Plex Streams" ? "selected" : ""); ?>>Plex Streams</option>
                <option value="Emby Streams" <?php echo($cfg['WIDGET_TITLE'] === "Emby Streams" ? "selected" : ""); ?>>Emby Streams</option>
                <option value="Jellyfin Streams" <?php echo($cfg['WIDGET_TITLE'] === "Jellyfin Streams" ? "selected" : ""); ?>>Jellyfin Streams</option>
            </select>
        </div>
        
        <div class="as-form-row">
            <label>_(Widget Icon)_:</label>
            <select name="WIDGET_ICON" style="width: 200px;">
                <option value="streams" <?php echo($cfg['WIDGET_ICON'] === "streams" ? "selected" : ""); ?>>Generic (Film)</option>
                <option value="plex" <?php echo($cfg['WIDGET_ICON'] === "plex" ? "selected" : ""); ?>>Plex</option>
                <option value="emby" <?php echo($cfg['WIDGET_ICON'] === "emby" ? "selected" : ""); ?>>Emby</option>
                <option value="jellyfin" <?php echo($cfg['WIDGET_ICON'] === "jellyfin" ? "selected" : ""); ?>>Jellyfin</option>
            </select>
        </div>
        
        <div class="as-form-row">
            <label>_(Refresh Interval)_:</label>
            <input type="number" name="POLL_INTERVAL" value="<?php echo($cfg['POLL_INTERVAL']); ?>" min="1" max="60" style="width: 80px;"> _(seconds)_
        </div>
        
        <div class="as-form-row">
            <label>_(Display Dashboard Widget)_:</label>
            <input type="radio" name="DISPLAY_WIDGET" value="1" <?php echo($cfg['DISPLAY_WIDGET'] === "1" ? "checked" : ""); ?>/> _(On)_
            <input type="radio" name="DISPLAY_WIDGET" value="0" <?php echo($cfg['DISPLAY_WIDGET'] === "0" ? "checked" : ""); ?>/> _(Off)_
        </div>
        
        <input type="submit" value="_(Save Settings)_" class="as-btn as-btn-primary">
    </form>
</div>

<!-- Server Management Section -->
<div class="as-section">
    <h3><i class="fa fa-server"></i> _(Media Servers)_</h3>
    <p>_(Configure your Plex, Emby, and Jellyfin servers below.)_</p>
    
    <div class="as-server-list" id="serverList">
        <?php if (empty($servers)): ?>
            <div class="as-server-item" style="justify-content: center; color: #888;">
                <i class="fa fa-info-circle"></i> _(No servers configured. Add one below.)_
            </div>
        <?php else: ?>
            <?php foreach ($servers as $index => $server): ?>
                <div class="as-server-item" data-index="<?php echo $index; ?>">
                    <span class="server-type type-<?php echo htmlspecialchars($server['type']); ?>">
                        <i class="fa fa-<?php echo $server['type'] === 'plex' ? 'play-circle' : ($server['type'] === 'emby' ? 'film' : 'film'); ?>"></i>
                        <?php echo htmlspecialchars($server['type']); ?>
                    </span>
                    <span class="server-name"><?php echo htmlspecialchars($server['name']); ?></span>
                    <span class="server-host"><?php echo htmlspecialchars($server['host']); ?>:<?php echo htmlspecialchars($server['port']); ?></span>
                    <span class="server-actions">
                        <button class="as-btn as-btn-secondary" onclick="editServer(<?php echo $index; ?>)"><i class="fa fa-pencil"></i></button>
                        <button class="as-btn as-btn-danger" onclick="deleteServer(<?php echo $index; ?>)"><i class="fa fa-trash"></i></button>
                    </span>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
    
    <button class="as-btn as-btn-primary" onclick="openAddModal()">
        <i class="fa fa-plus"></i> _(Add Server)_
    </button>
</div>

<!-- Add/Edit Server Modal -->
<div class="as-modal" id="serverModal">
    <div class="as-modal-content">
        <h3 id="modalTitle"><i class="fa fa-server"></i> _(Add Server)_</h3>
        <form id="serverForm">
            <input type="hidden" id="editIndex" value="-1">
            
            <div class="as-form-row">
                <label>_(Server Type)_:</label>
                <select id="serverType" onchange="updateFormFields()">
                    <option value="plex">Plex</option>
                    <option value="emby">Emby</option>
                    <option value="jellyfin">Jellyfin</option>
                </select>
            </div>
            
            <div class="as-form-row">
                <label>_(Display Name)_:</label>
                <input type="text" id="serverName" placeholder="My Plex Server" required>
                <div class="hint">_(A friendly name to identify this server)_</div>
            </div>
            
            <div class="as-form-row">
                <label>_(Host IP/Hostname)_:</label>
                <input type="text" id="serverHost" placeholder="192.168.1.50" required>
            </div>
            
            <div class="as-form-row">
                <label>_(Port)_:</label>
                <input type="number" id="serverPort" placeholder="32400">
                <div class="hint" id="portHint">_(Default: 32400 for Plex)_</div>
            </div>
            
            <div class="as-form-row">
                <label id="tokenLabel">_(API Token/Key)_:</label>
                <input type="password" id="serverToken" required>
                <div class="hint" id="tokenHint">_(Plex: X-Plex-Token from browser. Emby/Jellyfin: API Key from Dashboard > Advanced > API Keys)_</div>
            </div>
            
            <div class="as-form-row">
                <label>
                    <input type="checkbox" id="serverSSL"> _(Use HTTPS/SSL)_
                </label>
            </div>
            
            <div class="as-test-result" id="testResult"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="as-btn as-btn-secondary" onclick="testConnection()">
                    <i class="fa fa-plug"></i> _(Test Connection)_
                </button>
                <button type="submit" class="as-btn as-btn-primary">
                    <i class="fa fa-save"></i> _(Save Server)_
                </button>
                <button type="button" class="as-btn" onclick="closeModal()">
                    _(Cancel)_
                </button>
            </div>
        </form>
    </div>
</div>

<script>
var servers = <?php echo json_encode($servers); ?>;

function updateFormFields() {
    var type = $('#serverType').val();
    var ports = { plex: 32400, emby: 8096, jellyfin: 8096 };
    var hints = { 
        plex: '_(Default: 32400 for Plex)_', 
        emby: '_(Default: 8096 for Emby, 8920 for HTTPS)_', 
        jellyfin: '_(Default: 8096 for Jellyfin, 8920 for HTTPS)_' 
    };
    var tokenHints = {
        plex: '_(Find your X-Plex-Token in browser dev tools or Plex settings)_',
        emby: '_(Generate in Emby Dashboard > Advanced > API Keys)_',
        jellyfin: '_(Generate in Jellyfin Dashboard > Advanced > API Keys)_'
    };
    
    $('#serverPort').attr('placeholder', ports[type]);
    $('#portHint').text(hints[type]);
    $('#tokenHint').text(tokenHints[type]);
    $('#tokenLabel').text(type === 'plex' ? '_(Plex Token)_:' : '_(API Key)_:');
}

function openAddModal() {
    $('#editIndex').val(-1);
    $('#modalTitle').html('<i class="fa fa-server"></i> _(Add Server)_');
    $('#serverForm')[0].reset();
    $('#serverType').val('plex');
    updateFormFields();
    $('#testResult').hide();
    $('#serverModal').fadeIn(200);
}

function editServer(index) {
    var server = servers[index];
    $('#editIndex').val(index);
    $('#modalTitle').html('<i class="fa fa-server"></i> _(Edit Server)_');
    $('#serverType').val(server.type);
    $('#serverName').val(server.name);
    $('#serverHost').val(server.host);
    $('#serverPort').val(server.port);
    $('#serverToken').val(server.token);
    $('#serverSSL').prop('checked', server.ssl === true || server.ssl === '1');
    updateFormFields();
    $('#testResult').hide();
    $('#serverModal').fadeIn(200);
}

function closeModal() {
    $('#serverModal').fadeOut(200);
}

function deleteServer(index) {
    if (confirm('_(Are you sure you want to delete this server?)_')) {
        $.post('/plugins/activestreams/activestreams_servers.php', {
            action: 'delete',
            index: index
        }, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('_(Error deleting server)_: ' + response.error);
            }
        }, 'json');
    }
}

function testConnection() {
    var data = {
        action: 'test',
        type: $('#serverType').val(),
        host: $('#serverHost').val(),
        port: $('#serverPort').val() || getDefaultPort($('#serverType').val()),
        token: $('#serverToken').val(),
        ssl: $('#serverSSL').is(':checked') ? '1' : '0'
    };
    
    $('#testResult').removeClass('as-test-success as-test-error').html('<i class="fa fa-spinner fa-spin"></i> _(Testing...)_').show();
    
    $.post('/plugins/activestreams/activestreams_servers.php', data, function(response) {
        if (response.success) {
            $('#testResult').removeClass('as-test-error').addClass('as-test-success')
                .html('<i class="fa fa-check"></i> _(Connection successful!)_ ' + (response.message || ''));
        } else {
            $('#testResult').removeClass('as-test-success').addClass('as-test-error')
                .html('<i class="fa fa-times"></i> _(Connection failed)_: ' + response.error);
        }
    }, 'json').fail(function() {
        $('#testResult').removeClass('as-test-success').addClass('as-test-error')
            .html('<i class="fa fa-times"></i> _(Request failed)_');
    });
}

function getDefaultPort(type) {
    return type === 'plex' ? 32400 : 8096;
}

$('#serverForm').on('submit', function(e) {
    e.preventDefault();
    
    var data = {
        action: $('#editIndex').val() === '-1' ? 'add' : 'edit',
        index: $('#editIndex').val(),
        type: $('#serverType').val(),
        name: $('#serverName').val(),
        host: $('#serverHost').val(),
        port: $('#serverPort').val() || getDefaultPort($('#serverType').val()),
        token: $('#serverToken').val(),
        ssl: $('#serverSSL').is(':checked') ? '1' : '0'
    };
    
    $.post('/plugins/activestreams/activestreams_servers.php', data, function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('_(Error saving server)_: ' + response.error);
        }
    }, 'json');
});

// Close modal on background click
$('#serverModal').on('click', function(e) {
    if (e.target === this) closeModal();
});
</script>

<?endif;?>
